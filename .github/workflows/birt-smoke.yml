name: BIRT smoke test

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare artifacts dir
        run: |
          mkdir -p artifacts tests/scripts

      - name: Build Docker image
        run: |
          docker build --pull --no-cache -t gt2-birt:test .

      - name: Run container
        run: |
          docker run -d --name birt -p 8080:8080 \
            -e CATALINA_OPTS="-Dbirt.home=/opt/tomcat/webapps/birt/WEB-INF -Dbirt.engine.home=/opt/tomcat/webapps/birt/WEB-INF/platform" \
            -v "${{ github.workspace }}/tests:/opt/tomcat/webapps/birt/tests:ro" \
            gt2-birt:test

      - name: Readiness check (Tomcat/BIRT up)
        run: |
          bash tests/scripts/wait_for_http.sh "http://localhost:8080/birt/" 180


      - name: Inspect BIRT runtime (plugins, logs, env)
        if: always()
        run: |
          set -x
          docker exec birt bash -lc '
            echo "--- PLATFORM PLUGINS (grep oda) ---";
            ls -1 /opt/tomcat/webapps/birt/WEB-INF/platform/plugins | grep -E "org\.eclipse\.datatools.*oda" || true;
            echo "--- XML ODA plugin.xml (first lines) ---";
            for j in /opt/tomcat/webapps/birt/WEB-INF/platform/plugins/org.eclipse.datatools.*oda*.jar; do
              [ -f "$j" ] || continue;
              echo ">>> $j";
              unzip -p "$j" plugin.xml | sed -n "1,120p" || true;
            done;
            echo "--- Viewer web.xml (head) ---";
            sed -n "1,220p" /opt/tomcat/webapps/birt/WEB-INF/web.xml || true;
            echo "--- OSGi configuration logs ---";
            cat /opt/tomcat/webapps/birt/WEB-INF/platform/configuration/*.log 2>/dev/null || true;
            echo "--- OSGi workspace .metadata/.log ---";
            cat /opt/tomcat/webapps/birt/WEB-INF/platform/.metadata/.log 2>/dev/null || true;
            echo "--- Viewer logs dir ---";
            ls -l /opt/tomcat/webapps/birt/WEB-INF/logs 2>/dev/null || true;
            echo "--- Tomcat work logs (if any) ---";
            find /opt/tomcat/work -maxdepth 3 -type f -name "*.log" -ls 2>/dev/null || true;
            echo "--- env ---";
            env | sort;
          ' || true

      - name: Upload BIRT diagnostic bundle
        if: always()
        run: |
          mkdir -p artifacts
          docker cp birt:/opt/tomcat/webapps/birt/WEB-INF/platform artifacts/platform 2>/dev/null || true
          docker cp birt:/opt/tomcat/webapps/birt/WEB-INF/logs artifacts/viewer-logs 2>/dev/null || true
          docker cp birt:/opt/tomcat/work artifacts/tomcat-work 2>/dev/null || true
          tar -C artifacts -czf artifacts/birt-diag.tgz platform viewer-logs tomcat-work 2>/dev/null || true

      - name: Upload zipped diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: birt-diag-tgz
          path: artifacts/birt-diag.tgz
          if-no-files-found: ignore

      - name: Collect textual diagnostics (lib inventory, env, web.xml)
        if: always()
        run: |
          mkdir -p artifacts
          docker exec birt bash -lc '
            set -e
            echo "=== WEB-INF/lib (first 200) ===" > /tmp/birt-diag.txt
            ls -la /opt/tomcat/webapps/birt/WEB-INF/lib | sed -n "1,200p" >> /tmp/birt-diag.txt || true
            echo "\n=== DTP/ODA jars present ===" >> /tmp/birt-diag.txt
            ls -1 /opt/tomcat/webapps/birt/WEB-INF/lib/org.eclipse.datatools*oda*.jar 2>/dev/null >> /tmp/birt-diag.txt || true
            echo "\n=== jar manifest / classes (head) ===" >> /tmp/birt-diag.txt
            for j in /opt/tomcat/webapps/birt/WEB-INF/lib/org.eclipse.datatools*.jar; do
              [ -f "$j" ] || continue; echo ">>> $j" >> /tmp/birt-diag.txt; (jar tf "$j" | sed -n "1,60p") >> /tmp/birt-diag.txt || true; done
            echo "\n=== web.xml (head) ===" >> /tmp/birt-diag.txt
            sed -n "1,220p" /opt/tomcat/webapps/birt/WEB-INF/web.xml >> /tmp/birt-diag.txt || true
            echo "\n=== env ===" >> /tmp/birt-diag.txt
            env | sort >> /tmp/birt-diag.txt
            echo "\n=== birt tree (depth 3) ===" >> /tmp/birt-diag.txt
            find /opt/tomcat/webapps/birt -maxdepth 3 -printf "%y %p\n" | sort >> /tmp/birt-diag.txt
          '
          docker cp birt:/tmp/birt-diag.txt artifacts/birt-diag.txt || true

      - name: Upload textual diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: birt-diag-txt
          path: artifacts/birt-diag.txt
          if-no-files-found: ignore

      - name: Inspect container (paths and viewer config)
        run: |
          docker exec birt sh -lc '
            echo "PWD:"; pwd; echo;
            echo "List birt root:"; ls -la /opt/tomcat/webapps/birt || true; echo;
            echo "List tests:"; ls -la /opt/tomcat/webapps/birt/tests || true; echo;
            echo "List tests/data:"; ls -la /opt/tomcat/webapps/birt/tests/data || true; echo;
            echo "CSV head:"; head -n 5 /opt/tomcat/webapps/birt/tests/data/data.csv || true; echo;
            echo "XML head:"; head -n 20 /opt/tomcat/webapps/birt/tests/data/data.xml || true; echo;
            echo "WEB-INF/lib contents:"; ls -la /opt/tomcat/webapps/birt/WEB-INF/lib | sed -n '1,120p' || true; echo;
            echo "WEB-INF/platform existence:"; ls -la /opt/tomcat/webapps/birt/WEB-INF/platform || echo "(missing)"; echo;
            echo "Viewer working folder in web.xml:";
            awk "/BIRT_VIEWER_WORKING_FOLDER/{print; getline; print}" /opt/tomcat/webapps/birt/WEB-INF/web.xml || true
          '
          {
            echo "## Container debug";
            echo;
            echo "- tests dir mapped to /opt/tomcat/webapps/birt/tests";
            echo "- data.csv expected at /opt/tomcat/webapps/birt/tests/data/data.csv";
            echo "- data.xml expected at /opt/tomcat/webapps/birt/tests/data/data.xml";
            echo "- WEB-INF/platform status noted (present/absent)";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Detect BIRT viewer endpoint and render report
        id: render
        env:
          OUT_HTML: artifacts/rendered.html
        run: |
          set -u
          bash tests/scripts/find_birt_endpoint.sh > artifacts/viewer_base.txt
          VIEWER_BASE=$(cat artifacts/viewer_base.txt)
          echo "Viewer base: $VIEWER_BASE"

          # Try preview, frameset, then run
          if bash tests/scripts/render_report.sh "$VIEWER_BASE" "tests/reports/smoke.rptdesign" html "$OUT_HTML" preview ; then
            echo "endpoint=preview" >> $GITHUB_OUTPUT
          elif bash tests/scripts/render_report.sh "$VIEWER_BASE" "tests/reports/smoke.rptdesign" html "$OUT_HTML" frameset ; then
            echo "endpoint=frameset" >> $GITHUB_OUTPUT
          elif bash tests/scripts/render_report.sh "$VIEWER_BASE" "tests/reports/smoke.rptdesign" html "$OUT_HTML" run ; then
            echo "endpoint=run" >> $GITHUB_OUTPUT
          else
            echo "Render failed" >&2
            echo "URL tried: $VIEWER_BASE" >&2
            echo "If render.html exists, dump its first lines:" >&2
            head -n 60 "$OUT_HTML" 2>/dev/null || true
            exit 1
          fi

      - name: Show rendered output (snippet)
        if: always()
        run: |
          echo "First 120 lines of rendered output:";
          head -n 120 artifacts/rendered.html || true
          echo "\nLines with SMOKE/TOTAL (if any):";
          grep -nE "SMOKE|TOTAL" artifacts/rendered.html || true
          {
            echo "## Rendered HTML snippet";
            echo;
            echo "<details><summary>First 120 lines</summary>";
            echo;
            echo '```html';
            head -n 120 artifacts/rendered.html || true;
            echo '```';
            echo "</details>";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Assertions
        run: |
          bash tests/scripts/assert_render.sh artifacts/rendered.html artifacts/http_status.txt "SMOKE_OK" "TOTAL=3"

      - name: Upload rendered artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: birt-rendered
          path: |
            artifacts/rendered.html
            artifacts/http_status.txt
            artifacts/viewer_base.txt

      - name: Collect Docker logs
        if: always()
        run: |
          docker logs birt > artifacts/docker.log || true
          echo "## Docker logs" >> "$GITHUB_STEP_SUMMARY"
          echo "\n<details><summary>Click to expand logs</summary>\n" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          tail -n 500 artifacts/docker.log >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "\n</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: birt-logs
          path: |
            artifacts/docker.log

      - name: Cleanup
        if: always()
        run: |
          docker rm -f birt || true
